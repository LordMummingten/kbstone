<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="KB Stone">
  <meta name="theme-color" content="#00A3E8">
  <title>KB Stone Pro</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="installBanner" class="install-banner hide">
  <span>ğŸ“² Install KB Stone for quick access</span>
  <div>
    <button onclick="installApp()">Install</button>
    <button class="close-btn" onclick="dismissInstall()">Ã—</button>
  </div>
</div>

<div class="header">
  <div class="header-row">
    <div class="logo">KB Stone<small>Pro Quote System v2</small></div>
    <div style="display:flex;align-items:center;gap:8px;">
      <div class="view-btns">
        <button id="btnInt" class="active" onclick="setView('int')">Internal</button>
        <button id="btnCli" onclick="setView('cli')">Client</button>
      </div>
      <button class="hamburger-btn" onclick="toggleAdmin()" aria-label="Settings">
        <span></span><span></span><span></span>
      </button>
    </div>
  </div>
  <div class="biz">KB Stone Pty Ltd | ABN 75 686 625 801 | 0451 838 748 | kieron@kbstone.org</div>
</div>

<!-- Admin Sidebar Overlay -->
<div id="adminOverlay" class="admin-overlay" onclick="toggleAdmin()"></div>

<!-- Admin Sidebar Panel -->
<div id="adminPanel" class="admin-panel">
  <div class="admin-header">
    <h2>âš™ï¸ Settings</h2>
    <button class="admin-close" onclick="toggleAdmin()">Ã—</button>
  </div>
  
  <div class="admin-content">
    <!-- Block Type Manager -->
    <div class="admin-section">
      <div class="admin-section-head" onclick="toggleAdminSection('blocks')">
        <span>ğŸ§± Block Types</span>
        <span class="admin-arrow">â–¼</span>
      </div>
      <div id="adminBlocks" class="admin-section-body">
        <div id="blockTypeList"></div>
        <div class="admin-add-row">
          <input type="text" id="newBlockCode" placeholder="Code (e.g. lg)" style="width:60px">
          <input type="text" id="newBlockName" placeholder="Name (e.g. 600Ã—400Ã—300 Large)">
        </div>
        <div class="admin-add-row">
          <input type="number" id="newBlockPrice" placeholder="Price" style="width:70px">
          <input type="number" id="newBlockHeight" placeholder="H (m)" step="0.01" style="width:70px">
          <input type="number" id="newBlockLength" placeholder="L (m)" step="0.1" style="width:70px">
          <input type="number" id="newBlockHD" placeholder="HD" step="0.1" style="width:60px" value="1">
        </div>
        <button class="admin-btn" onclick="addBlockType()">+ Add Block Type</button>
      </div>
    </div>

    <!-- Material Pricing Manager -->
    <div class="admin-section">
      <div class="admin-section-head" onclick="toggleAdminSection('materials')">
        <span>ğŸ’° Material Pricing</span>
        <span class="admin-arrow">â–¼</span>
      </div>
      <div id="adminMaterials" class="admin-section-body">
        <div class="admin-field">
          <label>Cement (per bag)</label>
          <input type="number" id="matCement" step="0.5" onchange="updateMaterial('cement')">
        </div>
        <div class="admin-field">
          <label>Sand (per scoop)</label>
          <input type="number" id="matSand" step="0.5" onchange="updateMaterial('sand')">
        </div>
        <div class="admin-field">
          <label>Capping (each)</label>
          <input type="number" id="matCap" step="0.5" onchange="updateMaterial('cap')">
        </div>
        <div class="admin-field">
          <label>AG Pipe (per m)</label>
          <input type="number" id="matPipe" step="0.5" onchange="updateMaterial('pipe')">
        </div>
        <div class="admin-field">
          <label>Reo Bar (per m)</label>
          <input type="number" id="matReo" step="0.5" onchange="updateMaterial('reo')">
        </div>
        <div class="admin-field">
          <label>Oxide (each)</label>
          <input type="number" id="matOxide" step="0.5" onchange="updateMaterial('oxide')">
        </div>
        <div class="admin-field">
          <label>Stick Joints (each)</label>
          <input type="number" id="matStick" step="0.5" onchange="updateMaterial('stick')">
        </div>
      </div>
    </div>

    <!-- Equipment Rates Manager -->
    <div class="admin-section">
      <div class="admin-section-head" onclick="toggleAdminSection('equipment')">
        <span>ğŸšœ Equipment Rates</span>
        <span class="admin-arrow">â–¼</span>
      </div>
      <div id="adminEquipment" class="admin-section-body">
        <div class="admin-field">
          <label>Staff/Machine (per day)</label>
          <input type="number" id="equipStaff" step="50" onchange="updateEquipment('staff')">
        </div>
        <div class="admin-field">
          <label>Mobilisation (per km)</label>
          <input type="number" id="equipMob" step="0.1" onchange="updateEquipment('mob')">
        </div>
        <div class="admin-field">
          <label>Delivery (per load)</label>
          <input type="number" id="equipDel" step="5" onchange="updateEquipment('del')">
        </div>
        <div class="admin-subsection">
          <label style="font-weight:600;margin-bottom:8px;display:block;">Skip Bin Prices</label>
          <div class="admin-field">
            <label>2mÂ³ Skip</label>
            <input type="number" id="skip2" step="10" onchange="updateSkipPrice(2)">
          </div>
          <div class="admin-field">
            <label>3mÂ³ Skip</label>
            <input type="number" id="skip3" step="10" onchange="updateSkipPrice(3)">
          </div>
          <div class="admin-field">
            <label>4mÂ³ Skip</label>
            <input type="number" id="skip4" step="10" onchange="updateSkipPrice(4)">
          </div>
          <div class="admin-field">
            <label>6mÂ³ Skip</label>
            <input type="number" id="skip6" step="10" onchange="updateSkipPrice(6)">
          </div>
        </div>
        <div class="admin-subsection">
          <label style="font-weight:600;margin-bottom:8px;display:block;">Cutting Rates</label>
          <div class="admin-field">
            <label>Base Cut Cost</label>
            <input type="number" id="cutBase" step="0.5" onchange="updateCutting('base')">
          </div>
          <div class="admin-field">
            <label>Blade Wear Cost</label>
            <input type="number" id="cutBlade" step="0.1" onchange="updateCutting('blade')">
          </div>
        </div>
      </div>
    </div>

    <!-- Profit & GST Settings -->
    <div class="admin-section">
      <div class="admin-section-head" onclick="toggleAdminSection('rates')">
        <span>ğŸ“Š Profit & GST</span>
        <span class="admin-arrow">â–¼</span>
      </div>
      <div id="adminRates" class="admin-section-body">
        <div class="admin-field">
          <label>Waste Allowance (%)</label>
          <input type="number" id="rateWaste" step="1" onchange="updateRate('waste')">
        </div>
        <div class="admin-field">
          <label>Profit Margin (%)</label>
          <input type="number" id="rateProfit" step="1" onchange="updateRate('profit')">
        </div>
        <div class="admin-field">
          <label>GST (%)</label>
          <input type="number" id="rateGst" step="1" onchange="updateRate('gst')">
        </div>
        <div class="admin-field">
          <label>Blocks Per Hour (labour)</label>
          <input type="number" id="rateBph" step="1" onchange="updateRate('bph')">
        </div>
      </div>
    </div>

    <!-- Theme Toggle -->
    <div class="admin-section">
      <div class="admin-section-head" onclick="toggleAdminSection('theme')">
        <span>ğŸ¨ Appearance</span>
        <span class="admin-arrow">â–¼</span>
      </div>
      <div id="adminTheme" class="admin-section-body">
        <div class="theme-toggle-row">
          <span>Dark Mode</span>
          <div class="toggle" id="togDarkMode" onclick="toggleDarkMode()"></div>
        </div>
      </div>
    </div>

    <!-- App Icon Settings -->
    <div class="admin-section">
      <div class="admin-section-head" onclick="toggleAdminSection('icons')">
        <span>ğŸ“± App Icons</span>
        <span class="admin-arrow">â–¼</span>
      </div>
      <div id="adminIcons" class="admin-section-body">
        <p class="admin-hint">Upload custom icons for PWA installation. Icons should be square PNG images.</p>
        <div class="admin-field">
          <label>192Ã—192 Icon</label>
          <input type="file" id="icon192Upload" accept="image/png" onchange="handleIconUpload(192)">
        </div>
        <div class="admin-field">
          <label>512Ã—512 Icon</label>
          <input type="file" id="icon512Upload" accept="image/png" onchange="handleIconUpload(512)">
        </div>
        <div class="admin-field">
          <label>180Ã—180 Apple Icon</label>
          <input type="file" id="icon180Upload" accept="image/png" onchange="handleIconUpload(180)">
        </div>
        <p class="admin-hint" style="margin-top:10px;">Note: Icon changes require re-installing the PWA.</p>
      </div>
    </div>

    <!-- Reset to Defaults -->
    <div class="admin-section">
      <button class="admin-btn admin-btn-danger" onclick="resetToDefaults()">ğŸ”„ Reset All to Defaults</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast">Settings Saved âœ“</div>

<!-- Wall Diagram Modal -->
<div id="diagramModal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeDiagram()">&times;</span>
    <h3 style="margin-top:0;">Wall Block Diagram</h3>
    <canvas id="diagramCanvas"></canvas>
    <div style="margin-top:15px;">
      <button class="btn btn-primary" onclick="saveDiagramPNG()">ğŸ’¾ Save PNG</button>
      <button class="btn btn-outline" onclick="attachDiagramToPDF()">ğŸ“ Attach to PDF</button>
    </div>
  </div>
</div>

<div class="container">
  
  <!-- CLIENT DETAILS -->
  <div class="card">
    <div class="card-title">Client Details</div>
    <div class="row2">
      <div><label>Quote #</label><input id="qNum" readonly></div>
      <div><label>Date</label><input type="date" id="qDate"></div>
    </div>
    <div class="row2">
      <div><label>Client Name</label><input id="cName" placeholder="Name"></div>
      <div><label>Phone</label><input id="cPhone" placeholder="Phone"></div>
    </div>
    <label>Address</label><input id="cAddr" placeholder="Project address">
    <div class="row2">
      <div><label>Project Type</label>
        <select id="pType">
          <option>Retaining Wall</option>
          <option>Garden Bed</option>
          <option>Letterbox</option>
          <option>Stairs</option>
          <option>Pizza Oven</option>
          <option>Feature Wall</option>
          <option>Boundary Wall</option>
          <option>Seating/Bench</option>
          <option>BBQ Area</option>
          <option>Custom</option>
        </select>
      </div>
      <div><label>Notes</label><input id="notes" placeholder="Access, slopes..."></div>
    </div>
  </div>

  <!-- BLOCK GROUPS -->
  <div class="card">
    <div class="card-title">Block Groups</div>
    <div id="groupsBox"></div>
    <button class="add-btn" onclick="addGroup()">+ Add Block Group</button>
  </div>

  <!-- EQUIPMENT -->
  <div class="card">
    <div class="card-title">Equipment & Services</div>
    <div class="row3">
      <div>
        <label>Staff Days</label>
        <input type="number" id="staffDays" value="0" step="0.5" onchange="calcAll()">
        <div class="hint">$2,000/day</div>
      </div>
      <div>
        <label>Mobilis. (km)</label>
        <input type="number" id="mobKm" value="0" onchange="calcAll()">
        <div class="hint">$1.50/km</div>
      </div>
      <div>
        <label>Delivery</label>
        <input type="number" id="delLoads" value="0" onchange="calcAll()">
        <div class="hint">$120/load</div>
      </div>
    </div>
    <div class="toggle-row">
      <label>Skip Bin</label>
      <div class="toggle" id="togSkip" onclick="togSkip()"></div>
    </div>
    <div id="skipSec" class="nested hide">
      <label>Size</label>
      <select id="skipSize" onchange="calcAll()">
        <option value="300">2mÂ³ â€“ $300</option>
        <option value="350">3mÂ³ â€“ $350</option>
        <option value="400" selected>4mÂ³ â€“ $400</option>
        <option value="600">6mÂ³ â€“ $600</option>
      </select>
    </div>
  </div>

  <!-- TOTALS -->
  <div class="card">
    <div class="card-title">Grand Totals</div>
    <div id="matSummary"></div>
    <div id="intBox" class="internal"></div>
    <div id="cliBox"></div>
    <div class="total-box">
      <div class="lbl">TOTAL (inc GST)</div>
      <div class="amt" id="grandTot">$0.00</div>
    </div>
    <div class="terms">
      <strong>Terms:</strong> 50% deposit on booking â€¢ 50% on completion â€¢ 
      Variations quoted separately â€¢ Weather delays may apply â€¢ Valid 30 days
    </div>
  </div>

  <!-- BUTTONS -->
  <button class="btn btn-primary" onclick="pdfQuote()">ğŸ“„ Client Quote PDF</button>
  <button class="btn btn-dark" onclick="pdfMaterials()">ğŸ“¦ Materials Order</button>
  <button class="btn btn-outline" onclick="pdfJob()">ğŸ‘· Job Sheet</button>
  
</div>

<script src="worker.js"></script>
<script src="pdf.js"></script>
<script src="admin.js"></script>
<script src="pwa.js"></script>

</body>
</html>
